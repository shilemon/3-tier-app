
name: CI-CD (EKS + ECR Public)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write   # required for GitHub OIDC -> AWS role assumption [1](https://github.com/aws-actions/configure-aws-credentials)[2](https://deepwiki.com/aws-actions/configure-aws-credentials/2-installation-and-usage)

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  EKS_CLUSTER_NAME: ${{ secrets.EKS_CLUSTER_NAME }}
  KUBE_NAMESPACE: three-tier

  # Your ECR Public registry/repo prefixes:
  ECR_PUBLIC_REGISTRY: public.ecr.aws/a5b3x2v6
  BACKEND_IMAGE: public.ecr.aws/a5b3x2v6/three-tier-backend
  FRONTEND_IMAGE: public.ecr.aws/a5b3x2v6/three-tier-frontend

jobs:
  test:
    name: Test (optional)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional backend tests
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "14"

      - name: Backend npm install
        working-directory: backend
        run: npm install

      # Uncomment if you have tests
      # - name: Backend tests
      #   working-directory: backend
      #   run: npm test

      - name: Frontend npm install
        working-directory: frontend
        run: npm install

      # Uncomment if you have tests
      # - name: Frontend tests
      #   working-directory: frontend
      #   run: npm test

  build_and_push:
    name: Build & Push Images (ECR Public)
    runs-on: ubuntu-latest
    needs: [ test ]

    outputs:
      image_tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      # This action is designed for secure role assumption via OIDC. [1](https://github.com/aws-actions/configure-aws-credentials)[2](https://deepwiki.com/aws-actions/configure-aws-credentials/2-installation-and-usage)

      - name: Set image tag
        id: meta
        run: |
          echo "tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Login to Amazon ECR Public
        run: |
          # IMPORTANT: ECR Public login must be done against us-east-1. [3](https://docs.aws.amazon.com/AmazonECR/latest/public/public-registry-auth.html)[4](https://awscli.amazonaws.com/v2/documentation/api/2.4.18/reference/ecr-public/get-login-password.html)
          aws ecr-public get-login-password --region us-east-1 \
            | docker login --username AWS --password-stdin public.ecr.aws

      - name: Build backend image
        run: |
          docker build -t $BACKEND_IMAGE:${{ steps.meta.outputs.tag }} ./backend
          docker tag $BACKEND_IMAGE:${{ steps.meta.outputs.tag }} $BACKEND_IMAGE:latest

      - name: Build frontend image
        run: |
          docker build -t $FRONTEND_IMAGE:${{ steps.meta.outputs.tag }} ./frontend
          docker tag $FRONTEND_IMAGE:${{ steps.meta.outputs.tag }} $FRONTEND_IMAGE:latest

      - name: Push backend image
        run: |
          docker push $BACKEND_IMAGE:${{ steps.meta.outputs.tag }}
          docker push $BACKEND_IMAGE:latest

      - name: Push frontend image
        run: |
          docker push $FRONTEND_IMAGE:${{ steps.meta.outputs.tag }}
          docker push $FRONTEND_IMAGE:latest

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: [ build_and_push ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      [1](https://github.com/aws-actions/configure-aws-credentials)[2](https://deepwiki.com/aws-actions/configure-aws-credentials/2-installation-and-usage)

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --name "$EKS_CLUSTER_NAME" \
            --region "$AWS_REGION"
      # aws eks update-kubeconfig is the standard way to configure kubectl for EKS. [5](https://docs.aws.amazon.com/cli/latest/reference/eks/update-kubeconfig.html)

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -n $KUBE_NAMESPACE -f Kubernetes-Manifests-file/Database/
          kubectl apply -n $KUBE_NAMESPACE -f Kubernetes-Manifests-file/Backend/
          kubectl apply -n $KUBE_NAMESPACE -f Kubernetes-Manifests-file/Frontend/
          kubectl apply -n $KUBE_NAMESPACE -f Kubernetes-Manifests-file/ingress.yaml

      - name: Update images to new tag
        run: |
          TAG="${{ needs.build_and_push.outputs.image_tag }}"
          kubectl set image -n $KUBE_NAMESPACE deployment/api api=$BACKEND_IMAGE:$TAG
          kubectl set image -n $KUBE_NAMESPACE deployment/frontend frontend=$FRONTEND_IMAGE:$TAG

      - name: Rollout status
        run: |
          kubectl rollout status -n $KUBE_NAMESPACE deployment/api --timeout=180s
          kubectl rollout status -n $KUBE_NAMESPACE deployment/frontend --timeout=180s
